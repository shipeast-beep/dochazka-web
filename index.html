<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Docházka - generování a skenování QR</title>
  <style>
    body { font-family: sans-serif; margin: 20px; max-width: 400px; }
    label, button { display: block; margin-top: 10px; width: 100%; }
    input, select { padding: 8px; width: 100%; box-sizing: border-box; }
    #personalCard, #scanResult { margin-top: 20px; border: 1px solid #aaa; padding: 15px; display: none; }
    #qrCode { margin-top: 10px; }
    video { width: 100%; border: 1px solid #ccc; margin-top: 10px; display: none; }
  </style>
</head>
<body>

  <h1>Vytvoř osobní kartu</h1>

  <form id="personForm">
    <label for="firstName">Jméno</label>
    <input type="text" id="firstName" required />

    <label for="lastName">Příjmení</label>
    <input type="text" id="lastName" required />

    <label for="dob">Datum narození</label>
    <input type="date" id="dob" required />

    <label for="event">Událost</label>
    <select id="event" required>
      <option value="" disabled selected>Vyber událost</option>
      <option value="pracovni_dochazka">Pracovní docházka</option>
      <option value="kurz">Kurz</option>
      <option value="schuze">Schůze</option>
    </select>

    <button type="submit">Vytvořit kartu a QR</button>
  </form>

  <div id="personalCard">
    <h2>Personal Card</h2>
    <div><strong>Jméno:</strong> <span id="cardFirstName"></span></div>
    <div><strong>Příjmení:</strong> <span id="cardLastName"></span></div>
    <div><strong>Datum narození:</strong> <span id="cardDob"></span></div>
    <div><strong>Událost:</strong> <span id="cardEvent"></span></div>
    <div id="qrCode"></div>
  </div>

  <hr />

  <button id="startScan">Spustit skenování QR</button>
  <button id="stopScan" style="display:none;">Zastavit skenování</button>
  <video id="video" playsinline></video>

  <div id="scanResult"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js"></script>

  <!-- QRCode.js -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <!-- jsQR (pro čtení QR z videa) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCBT1qaXVyrLoeScMNxu6CeVyfdaEXbV2A",
      authDomain: "dochazka-web.firebaseapp.com",
      databaseURL: "https://dochazka-web-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dochazka-web",
      storageBucket: "dochazka-web.appspot.com",
      messagingSenderId: "451256792807",
      appId: "1:451256792807:web:e44f20bdedb6b3917dd442",
      measurementId: "G-B1HTEBEV84"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- Vytvoření karty + QR ---
    const form = document.getElementById('personForm');
    const card = document.getElementById('personalCard');
    const qrCodeContainer = document.getElementById('qrCode');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const firstName = form.firstName.value.trim();
      const lastName = form.lastName.value.trim();
      const dob = form.dob.value;
      const event = form.event.value;

      if (!firstName || !lastName || !dob || !event) {
        alert('Vyplňte všechny údaje');
        return;
      }

      const id = Date.now().toString() + Math.floor(Math.random() * 1000).toString();

      const data = { firstName, lastName, dob, event, id };

      try {
        await database.ref('persons/' + id).set(data);

        document.getElementById('cardFirstName').textContent = firstName;
        document.getElementById('cardLastName').textContent = lastName;
        document.getElementById('cardDob').textContent = dob;
        document.getElementById('cardEvent').textContent = event;

        qrCodeContainer.innerHTML = '';
        QRCode.toCanvas(id, { width: 150 }, (error, canvas) => {
          if (error) {
            alert('Chyba při generování QR kódu');
            return;
          }
          qrCodeContainer.appendChild(canvas);
          card.style.display = 'block';
        });

      } catch (err) {
        alert('Chyba při ukládání do databáze');
        console.error(err);
      }
    });

    // --- Skener QR ---
    const video = document.getElementById('video');
    const startScanBtn = document.getElementById('startScan');
    const stopScanBtn = document.getElementById('stopScan');
    const scanResult = document.getElementById('scanResult');

    let scanning = false;
    let videoStream = null;
    let scanAnimationFrame;

    function tick() {
      if (!scanning) return;

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code) {
        scanning = false;
        stopVideo();

        // Načti data z Firebase podle ID v QR
        database.ref('persons/' + code.data).get().then(snapshot => {
          if (snapshot.exists()) {
            const person = snapshot.val();
            scanResult.innerHTML =
              `<h3>Docházka načtena</h3>
               <div><strong>Jméno:</strong> ${person.firstName}</div>
               <div><strong>Příjmení:</strong> ${person.lastName}</div>
               <div><strong>Datum narození:</strong> ${person.dob}</div>
               <div><strong>Událost:</strong> ${person.event}</div>
               <div><strong>ID:</strong> ${person.id}</div>`;
          } else {
            scanResult.textContent = 'Osoba nenalezena v databázi.';
          }
        }).catch(err => {
          scanResult.textContent = 'Chyba při načítání dat.';
          console.error(err);
        });

        startScanBtn.style.display = 'inline-block';
        stopScanBtn.style.display = 'none';
        video.style.display = 'none';

      } else {
        scanAnimationFrame = requestAnimationFrame(tick);
      }
    }

    function startVideo() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.setAttribute('playsinline', true);
          video.play();
          video.style.display = 'block';
          scanning = true;
          scanResult.textContent = '';
          tick();
        })
        .catch(err => {
          alert('Nelze spustit kameru: ' + err.message);
          startScanBtn.style.display = 'inline-block';
          stopScanBtn.style.display = 'none';
        });
    }

    function stopVideo() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      video.style.display = 'none';
      scanning = false;
      if (scanAnimationFrame) cancelAnimationFrame(scanAnimationFrame);
    }

    startScanBtn.onclick = () => {
      startScanBtn.style.display = 'none';
      stopScanBtn.style.display = 'inline-block';
      scanResult.textContent = '';
      startVideo();
    };

    stopScanBtn.onclick = () => {
      stopVideo();
      startScanBtn.style.display = 'inline-block';
      stopScanBtn.style.display = 'none';
      scanResult.textContent = '';
    };
  </script>
</body>
</html>
