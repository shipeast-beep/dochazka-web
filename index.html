<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Doch√°zka App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f5f5f5; color: #333; }
    h1, h2 { margin-top: 30px; }
    form div { margin-bottom: 10px; }
    label { display: block; margin-bottom: 5px; }
    input[type="text"], input[type="date"], select {
      padding: 8px; width: 300px; max-width: 100%;
    }
    button {
      padding: 10px 15px; margin-top: 10px;
      background-color: #4CAF50; color: white; border: none; cursor: pointer;
    }
    button:disabled { background-color: #ccc; }
    #qrCodeContainer img {
      border: 1px solid #ddd; padding: 5px; margin-top: 20px;
    }
    #reader { width: 300px; max-width: 100%; margin-top: 20px; }
    #personCard, #scanResult { margin-top: 20px; }
    #startScanBtn, #stopScanBtn { margin: 5px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<h1>Doch√°zka App</h1>

<!-- Sekce: P≈ôid√°n√≠ osoby -->
<section>
  <h2>P≈ôidat osobu</h2>
  <form id="personForm">
    <div>
      <label for="firstName">Jm√©no:</label>
      <input type="text" id="firstName" required>
    </div>
    <div>
      <label for="lastName">P≈ô√≠jmen√≠:</label>
      <input type="text" id="lastName" required>
    </div>
    <div>
      <label for="birthDate">Datum narozen√≠:</label>
      <input type="date" id="birthDate" required>
    </div>
    <button type="submit">Vytvo≈ôit kartu</button>
  </form>
  <div id="personCard"></div>
  <div id="qrCodeContainer"></div>
</section>

<hr>

<!-- Sekce: Skener doch√°zky -->
<section>
  <h2>Skener doch√°zky</h2>

  <label for="eventSelect">Zvol ud√°lost:</label>
  <select id="eventSelect">
    <option value="P≈ô√≠chod">P≈ô√≠chod</option>
    <option value="Odchod">Odchod</option>
    <option value="Obƒõd">Obƒõd</option>
    <option value="P≈ôest√°vka">P≈ôest√°vka</option>
  </select>

  <br><br>
  <button id="startScanBtn">üì∑ Spustit skenov√°n√≠</button>
  <button id="stopScanBtn" style="display:none;">üõë Zastavit skenov√°n√≠</button>
  <div id="reader" style="display:none;"></div>
  <div id="scanResult"></div>
</section>

<!-- Firebase + hlavn√≠ skript -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, set, get, child, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  // Firebase konfigurace
  const firebaseConfig = {
    apiKey: "AIzaSyCBT1qaXVyrLoeScMNxu6CeVyfdaEXbV2A",
    authDomain: "dochazka-web.firebaseapp.com",
    projectId: "dochazka-web",
    storageBucket: "dochazka-web.firebasestorage.app",
    messagingSenderId: "451256792807",
    appId: "1:451256792807:web:e44f20bdedb6b3917dd442",
    measurementId: "G-B1HTEBEV84",
    databaseURL: "https://dochazka-web-default-rtdb.europe-west1.firebasedatabase.app"
  };

  // Inicializace Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();
  await signInAnonymously(auth);

  // P≈ôid√°n√≠ osoby
  const form = document.getElementById("personForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const firstName = document.getElementById("firstName").value.trim();
    const lastName = document.getElementById("lastName").value.trim();
    const birthDate = document.getElementById("birthDate").value;
    const id = crypto.randomUUID();
    const person = { id, firstName, lastName, birthDate };
    await set(ref(db, `people/${id}`), person);
    displayPersonCard(person);
    generateQRCode(id);
    form.reset();
  });

  function displayPersonCard(data) {
    const container = document.getElementById("personCard");
    container.innerHTML = `
      <h3>${data.firstName} ${data.lastName}</h3>
      <p>Datum narozen√≠: ${data.birthDate}</p>
      <p>ID: ${data.id}</p>
    `;
  }

  function generateQRCode(id) {
    const container = document.getElementById("qrCodeContainer");
    container.innerHTML = "";
    QRCode.toDataURL(id, { width: 200 }, (err, url) => {
      if (err) return console.error(err);
      const img = document.createElement("img");
      img.src = url;
      container.appendChild(img);
    });
  }

  // Skenov√°n√≠
  const reader = new Html5Qrcode("reader");
  const startScanBtn = document.getElementById("startScanBtn");
  const stopScanBtn = document.getElementById("stopScanBtn");
  const scanResult = document.getElementById("scanResult");
  const readerElem = document.getElementById("reader");
  const eventSelect = document.getElementById("eventSelect");

  let isScanning = false;
  let currentCamera = null;

  startScanBtn.addEventListener("click", async () => {
    if (isScanning) return;
    const cameras = await Html5Qrcode.getCameras();
    const backCam = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];
    currentCamera = backCam.id;
    await reader.start(currentCamera, { fps: 10, qrbox: 250 }, onScanSuccess, () => {});
    readerElem.style.display = "block";
    stopScanBtn.style.display = "inline-block";
    startScanBtn.style.display = "none";
    isScanning = true;
  });

  stopScanBtn.addEventListener("click", async () => {
    if (!isScanning) return;
    await reader.stop();
    readerElem.style.display = "none";
    stopScanBtn.style.display = "none";
    startScanBtn.style.display = "inline-block";
    scanResult.innerHTML = "";
    isScanning = false;
  });

  async function onScanSuccess(decodedText) {
    if (!isScanning) return;
    await reader.stop(); // zastav sken hned
    isScanning = false;
    readerElem.style.display = "none";
    stopScanBtn.style.display = "none";
    startScanBtn.style.display = "inline-block";

    try {
      const snapshot = await get(child(ref(db), `people/${decodedText}`));
      if (!snapshot.exists()) {
        scanResult.innerHTML = "<p style='color:red'>Osoba nenalezena.</p>";
        return;
      }
      const person = snapshot.val();
      const timestamp = Date.now();
      const event = eventSelect.value;
      await push(ref(db, `people/${decodedText}/attendance`), { timestamp, event });

      scanResult.innerHTML = `
        <h3>‚úÖ Zaznamen√°no</h3>
        <p><strong>${person.firstName} ${person.lastName}</strong></p>
        <p>Ud√°lost: <strong>${event}</strong></p>
        <p>ƒåas: ${new Date(timestamp).toLocaleString()}</p>
      `;
    } catch (e) {
      console.error(e);
      scanResult.innerHTML = "<p style='color:red'>Chyba p≈ôi naƒç√≠t√°n√≠ nebo z√°pisu.</p>";
    }
  }
</script>

</body>
</html>
